@startuml
skinparam monochrome true
skinparam packageStyle rectangle
skinparam shadowing false

title UI Sequence Diagram (SD) - Remove Drone from Inventory

autonumber

actor "Drone Tech" as DT
participant ":RemoveDroneInventoryUI" as UI
participant ":GetDronesController" as getDronesCtrl
participant "SerialNumber" as sn
participant "DroneRemovalLog" as removalLog
participant ":RemoveDroneInventoryController" as CTRL
participant "repositoryProvider\n:RepositoryProvider" as provider
participant "DroneRepository\n:DroneRepository" as dRepo
participant "InMemoryDroneRepository" as inMem
participant "DroneJPAImpl" as jpa
participant "Drone" as drone

activate DT

DT -> UI : requests to remove a drone from inventory
activate UI

UI -> getDronesCtrl ** : create
UI -> getDronesCtrl : getAllDrones()
activate getDronesCtrl
getDronesCtrl -> provider ** : droneRepository()
activate provider
provider --> getDronesCtrl : repository
deactivate provider
getDronesCtrl -> dRepo : findAll()
activate dRepo
dRepo --> getDronesCtrl : dronesList
deactivate dRepo
getDronesCtrl --> UI : Optional<dronesList>
deactivate getDronesCtrl

alt dronesList is empty
    UI --> DT : error message ("No drones in the system yet...")
    deactivate UI
    deactivate DT
else
    UI -> DT : provideSerialNumber()
    DT -> UI : serialNumber
    UI -> sn ** : Utils.readLineFromConsole()
    activate sn
    sn -> UI : serialNumber
    deactivate sn

    UI -> getDronesCtrl ** : create
    UI -> getDronesCtrl : getDroneBySN(serialNumber)
    activate getDronesCtrl
    getDronesCtrl -> dRepo : findByDroneSN(serialNumber)
    activate dRepo
    dRepo --> getDronesCtrl : Optional<Drone>
    deactivate dRepo
    getDronesCtrl --> UI : Optional<selectedDrone>
    deactivate getDronesCtrl

    alt selectedDrone is empty
        UI --> DT : error message ("No drone with that Serial Number found in the system!")
        deactivate UI
        deactivate DT
    else
        UI -> UI : checkDroneStatus(selectedDrone)
        alt drone status is not AVAILABLE
            UI --> DT : error message ("This drone is no longer available in the inventory. Current status: " + selectedDrone.get().droneStatus())
            deactivate UI
            deactivate DT
        else
            UI -> DT : showDroneDetails()
            DT -> UI : confirmSelection()
            alt confirmed
                UI -> removalLog ** : Utils.rePromptWhileInvalid()
                activate removalLog
                removalLog -> UI : removalLog
                deactivate removalLog

                UI -> CTRL ** : create
                UI -> CTRL : removeDrone(selectedDrone.get(), removalLog)
                activate CTRL
                CTRL -> provider ** : droneRepository()
                activate provider
                provider --> CTRL : repository (dynamic: inMem or jpa)
                deactivate provider

                alt Repository is InMemoryDroneRepository
                    CTRL -> inMem : removeDrone(selectedDrone.get(), removalLog)
                    activate inMem
                    inMem --> CTRL : Optional<Drone>
                    deactivate inMem
                else Repository is DroneJPAImpl
                    CTRL -> jpa : removeDrone(selectedDrone.get(), removalLog)
                    activate jpa
                    jpa --> CTRL : Optional<Drone>
                    deactivate jpa
                end

                CTRL --> UI : Optional<Drone>
                deactivate CTRL
            else
                note right : loops back to provideSerialNumber
            end
        end
    end

    alt Drone removed successfully
        UI --> DT : success message ("Drone removed successfully!")
    else Removal failed
        UI --> DT : error message ("Removal failed!")
    end
end

deactivate UI
deactivate DT

@enduml